language: rust

matrix:
  include:
    - rust: stable
      env: TARGET=x86_64-unknown-linux-gnu
    - rust: beta
      env: TARGET=x86_64-unknown-linux-gnu
    - rust: nightly
      env: TARGET=x86_64-unknown-linux-gnu

    - rust: stable
      os: osx
      env: TARGET=x86_64-apple-darwin

cache:
  timeout: 360
  cargo: true

before_cache:
  - chmod -R a+r $HOME/.cargo

env:
  global:
    - CRATE_NAME=mdbook

script:
  - cargo test --all
  - cargo test --all --no-default-features

before_deploy:
  - sh ci/before_deploy.sh

deploy:
  provider: releases
  api_key:
    - secure: y4SWsXH9P0g6ZixfGiOR3ReDnSEReIJToACdBD8PMljQtH4Hn8gmkkM0wkKYv1eU6GoN/lb9AM9BHRX5I9ySfD0M4eve6wewOjANk+DYNWfFV3F4r2SMN3HhjQ4Yi5ZACd/UD//K2iCXwyyd303c8NLPiMecvApVnvLYmnFm1zs7CcDnEFSZuY2SnJUsQPJSkshDwx3cygp1A5xMZU4nIoryqiQV00UReeet4Wy4YV+DuoUBFQlfuYdNsNInaHN9sNxf03WHAw4FfVbo9oyGO2Eih9hBw5LAazRRH38LDmaPw6EXIS/TDaeTVuo1TIHI5OJvEwDPWWXvac8shJTBfFocJwPirmAkteyYIX/YPwVeK72X9h+kjU47OhDz5cpTPSkLg8H96xxqsgha9Y5Bx8dGm0oX8NVNjm8+ENUrk1PN/M1vbcKUn3D55pNfSyJSHh66OPsNB5kR/vL6e8DG1R3g0QAAmI+6kEcFLOQh/LK0VzXAkh2tUHTCM5qlXKACFm8yqDU87Kr2xKGZ3I5pff0AURqgRe1wA/o11fqpTDFEa6nuZ1qrKHKYcVYHnG1r+1/qbMxy1E6gdFJ8ybZ4DsiW1xm98elhxpi+P7bsrhgR+ccSpUMSPbZUocaoxEUO3bUSrZNB0if5GuzxrRLlN3J0a1xJUETgHzpAwzW0Rrw=
  file_glob: true
  file: "$CRATE_NAME-$TRAVIS_TAG-$TARGET.*"
  on:
    condition: "$TRAVIS_RUST_VERSION = stable"
    tags: true
  skip_cleanup: true

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+.*$/

notifications:
  email:
    on_success: never
